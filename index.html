<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARKEO — Plan partagé</title>

  <!-- ✅ Supabase UMD (OBLIGATOIRE) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>

  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#0b1220;
      color:#e8eefc;
    }
    header{
      padding:16px 20px;
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .wrap{max-width:1000px;margin:0 auto;padding:20px}
    button{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.05);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.05);
      color:#fff;
    }
    .card{
      background:#101a2e;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:20px;
      margin-top:20px;
    }
    .hide{display:none}
    .toast{
      position:fixed;
      bottom:20px;
      right:20px;
      background:#101a2e;
      border:1px solid rgba(255,255,255,.2);
      padding:10px 14px;
      border-radius:12px;
      font-size:14px;
    }
  </style>
</head>

<body>

<header>
  <strong>ARKEO — Plan partagé</strong>
</header>

<div class="wrap">

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <h3>Connexion</h3>
    <p>Magic link email (recommandé)</p>

    <input id="loginEmail" placeholder="prenom@domaine.com" />
    <br><br>
    <button id="btnSendLink">Envoyer le lien</button>
  </div>

  <!-- APP -->
  <div class="card hide" id="appCard">
    <h3>Connecté</h3>
    <p id="userEmail"></p>
    <button id="btnLogout">Se déconnecter</button>
  </div>

</div>

<div class="toast hide" id="toast"></div>

<script>
/* ================= CONFIG ================= */

const SUPABASE_URL = "https://bejbipoebjzlsugyclqw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_TiMTmX-uqin2PVlsJsjGuw_b11OFSy8";

/* ============== CLIENT =================== */

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ============== HELPERS ================== */

const $ = id => document.getElementById(id);
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.remove("hide");
  clearTimeout(window.__t);
  window.__t = setTimeout(()=>t.classList.add("hide"), 3000);
}

/* ============== AUTH ===================== */

async function sendMagicLink(){
  const email = $("loginEmail").value.trim();
  if(!email){ toast("Email requis"); return; }

  try{
    const { error } = await supabaseClient.auth.signInWithOtp({
      email,
      options:{
        emailRedirectTo: window.location.href
      }
    });

    if(error) toast("Erreur: " + error.message);
    else toast("Lien envoyé. Vérifie ta boîte mail.");

  }catch(e){
    console.error(e);
    toast("Crash JS: " + e.message);
  }
}

async function logout(){
  await supabaseClient.auth.signOut();
  showLoggedOut();
}

/* ============== UI ======================= */

function showLoggedIn(user){
  $("loginCard").classList.add("hide");
  $("appCard").classList.remove("hide");
  $("userEmail").textContent = user.email;
}

function showLoggedOut(){
  $("loginCard").classList.remove("hide");
  $("appCard").classList.add("hide");
}

/* ============== BOOT ===================== */

$("btnSendLink").addEventListener("click", sendMagicLink);
$("btnLogout").addEventListener("click", logout);

supabaseClient.auth.getSession().then(({ data })=>{
  if(data.session){
    showLoggedIn(data.session.user);
  }else{
    showLoggedOut();
  }
});

supabaseClient.auth.onAuthStateChange((_event, session)=>{
  if(session?.user){
    showLoggedIn(session.user);
  }else{
    showLoggedOut();
  }
});
</script>

</body>
</html>
