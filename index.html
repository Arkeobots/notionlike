<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ARKEO ‚Äî Plan d‚Äôex√©cution (Terrain ‚Üí Sponsor 50k ‚Üí Pilote ‚Üí LOI)</title>

<!-- Supabase UMD local -->
<script src="./vendor/supabase.min.js"></script>

<style>
:root{--bg:#0b1220;--panel:#101a2e;--text:#e8eefc;--muted:#a9b7d6;--accent:#7aa2ff;--ok:#7ef0c2;--warn:#ffcd6b;--bad:#ff6b8a;--line:rgba(255,255,255,.08);--shadow:0 10px 30px rgba(0,0,0,.35);--r:18px;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
*{box-sizing:border-box}
body{margin:0;font-family:var(--sans);color:var(--text);background:radial-gradient(1200px 800px at 20% -10%,rgba(122,162,255,.25),transparent 55%),radial-gradient(900px 700px at 110% 10%,rgba(126,240,194,.12),transparent 50%),linear-gradient(180deg,#070b14,var(--bg));}
header{position:sticky;top:0;z-index:10;backdrop-filter:blur(14px);background:rgba(11,18,32,.75);border-bottom:1px solid var(--line);}
.wrap{max-width:1200px;margin:0 auto;padding:18px 18px 28px}
.top{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:14px 0;flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,rgba(122,162,255,.95),rgba(126,240,194,.85));box-shadow:var(--shadow)}
h1{font-size:18px;margin:0}
.sub{color:var(--muted);font-size:12px;margin-top:2px}
.actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:800}
button:hover{border-color:rgba(122,162,255,.5);background:rgba(255,255,255,.08)}
button.primary{background:rgba(122,162,255,.18);border-color:rgba(122,162,255,.35)}
button.good{background:rgba(126,240,194,.14);border-color:rgba(126,240,194,.3)}
button.warn{background:rgba(255,205,107,.12);border-color:rgba(255,205,107,.25)}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:18px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(16,26,46,.92),rgba(16,26,46,.72));border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
.hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);background:rgba(255,255,255,.03);gap:12px;flex-wrap:wrap}
.bd{padding:16px}
.section-title{font-weight:900;font-size:14px;margin:0}
.tiny{font-size:12px;color:var(--muted)}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
.field{flex:1;min-width:180px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select,textarea{width:100%;background:rgba(255,255,255,.03);border:1px solid var(--line);color:var(--text);border-radius:12px;padding:10px;outline:none}
textarea{min-height:90px;resize:vertical}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:rgba(255,255,255,.03)}
.pill.ok{border-color:rgba(126,240,194,.35);background:rgba(126,240,194,.12)}
.pill.warn{border-color:rgba(255,205,107,.35);background:rgba(255,205,107,.12)}
.pill.bad{border-color:rgba(255,107,138,.35);background:rgba(255,107,138,.12)}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media (max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.03)}
.kpi .label{color:var(--muted);font-size:12px}
.kpi .value{font-size:18px;font-weight:900;margin-top:6px}
.table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.02)}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top;font-size:13px}
.table th{color:var(--muted);font-weight:900;text-align:left;background:rgba(255,255,255,.03);position:sticky;top:0}
.table tr:last-child td{border-bottom:none}
.mono{font-family:var(--mono)}
.btnlink{font-size:12px;font-weight:900;padding:6px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.02);cursor:pointer}
.btnlink:hover{border-color:rgba(122,162,255,.55)}
.calendar{display:flex;flex-direction:column;gap:18px}
.cal-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.dow{color:var(--muted);font-size:12px;font-weight:900;text-align:center;padding:6px 0}
.day{border:1px solid var(--line);border-radius:14px;padding:10px;min-height:88px;background:rgba(255,255,255,.02)}
.day.out{opacity:.45}
.daynum{font-weight:900;font-size:12px;color:var(--muted)}
.event{margin-top:8px;font-size:12px;line-height:1.2;padding:6px 8px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);cursor:pointer;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
.template{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.02);padding:12px}
.template pre{margin:10px 0 0;padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);overflow:auto;font-size:12px;line-height:1.45;white-space:pre-wrap}
.footer{margin:24px 0 10px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.toast{position:fixed;right:16px;bottom:16px;background:rgba(16,26,46,.95);border:1px solid var(--line);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow);color:var(--text);font-size:13px;display:none;max-width:360px}
.hide{display:none !important;}
</style>
</head>

<body>

<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>ARKEO ‚Äî Plan d‚Äôex√©cution</h1>
        <div class="sub">Terrain ‚Üí Sponsor 50k ‚Üí Contrat ‚Üí Hardening (8 semaines) ‚Üí Pilote in-site ‚Üí Rapport ‚Üí LOI phase 2</div>
      </div>
    </div>

    <div class="actions">
      <span class="pill" id="authPill">Non connect√©</span>
      <button class="btnlink" id="btnOpenLogin">Se connecter</button>
      <button class="btnlink hide" id="btnLogout">Se d√©connecter</button>
      <button class="primary hide" id="btnAdd">+ Ajouter une t√¢che</button>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- LOGIN CARD -->
  <div class="card" id="loginCard">
    <div class="hd">
      <div>
        <div class="section-title">Connexion</div>
        <div class="tiny">Magic link email. Acc√®s: @arkeobots.com + whitelist.</div>
      </div>
      <span class="pill warn">Auth Supabase</span>
    </div>
    <div class="bd">
      <div class="row">
        <div class="field" style="flex:2">
          <label>Email</label>
          <input id="loginEmail" placeholder="prenom@arkeobots.com"/>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="good" id="btnSendLink">Envoyer le lien</button>
        </div>
      </div>
      <div class="tiny" style="margin-top:10px">Apr√®s clic sur le lien re√ßu, la page se reconnecte automatiquement.</div>
    </div>
  </div>

  <!-- APP -->
  <div class="card hide" id="appCard">
    <div class="hd">
      <div>
        <div class="section-title">Param√®tres</div>
        <div class="tiny mono" id="planMeta">‚Äî</div>
      </div>
      <span class="pill ok" id="pill">Plan pr√™t</span>
    </div>
    <div class="bd">
      <div class="row">
        <div class="field"><label>Date de d√©part (J0)</label><input type="date" id="startDate"></div>
        <div class="field"><label>Objectif cash</label><input id="targetCash" value="50 000 ‚Ç¨"></div>
        <div class="field"><label>Zone pilote</label><input id="pilotRegion" value="Catalogne (Barcelone si possible)"></div>
        <div class="field"><label>Op√©rateur in-site</label><input id="onsiteOwner" value="Thomas (CTO) ‚Äî full in-site"></div>
      </div>
      <div style="margin-top:14px" class="kpis">
        <div class="kpi"><div class="label">√âtape</div><div class="value" id="kStage">Terrain ‚Üí Email OK</div><div class="tiny">Le verrou qui rend le programme r√©el.</div></div>
        <div class="kpi"><div class="label">Sponsors</div><div class="value">2‚Äì3 max</div><div class="tiny">Peu, cibl√©s, 2 relances max.</div></div>
        <div class="kpi"><div class="label">Hardening</div><div class="value">8 semaines</div><div class="tiny">Jalons S4 et S7.</div></div>
        <div class="kpi"><div class="label">Pilote</div><div class="value">2‚Äì3 semaines</div><div class="tiny">KPIs simples + rapport.</div></div>
      </div>
    </div>
  </div>

  <div class="grid hide" id="grid">
    <!-- Left -->
    <div class="card">
      <div class="hd">
        <div>
          <div class="section-title">T√¢ches</div>
          <div class="tiny">Filtrez, √©ditez, cochez. Les √©ch√©ances apparaissent dans le calendrier.</div>
        </div>
        <div class="row">
          <div class="field" style="min-width:160px"><label>Statut</label>
            <select id="fStatus">
              <option value="all">Tous</option><option value="todo">√Ä faire</option><option value="doing">En cours</option><option value="blocked">Bloqu√©</option><option value="done">Fait</option>
            </select>
          </div>
          <div class="field" style="min-width:160px"><label>Type</label>
            <select id="fType">
              <option value="all">Tous</option>
              <option value="terrain">Terrain</option><option value="pack">Docs/Pack</option><option value="sponsor">Sponsor</option>
              <option value="contract">Contrat</option><option value="build">Hardening</option><option value="pilot">Pilote</option>
              <option value="report">Rapport</option><option value="loi">LOI phase 2</option>
            </select>
          </div>
        </div>
      </div>

      <div class="bd" style="padding:0">
        <div style="overflow:auto;max-height:580px">
          <table class="table">
            <thead><tr>
              <th style="min-width:280px">T√¢che</th>
              <th style="min-width:120px">Type</th>
              <th style="min-width:120px">Owner</th>
              <th style="min-width:120px">√âch√©ance</th>
              <th style="min-width:110px">Statut</th>
              <th style="min-width:220px">Notes</th>
              <th style="min-width:140px;text-align:right">Actions</th>
            </tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right -->
    <div class="calendar">
      <div class="card">
        <div class="hd">
          <div>
            <div class="section-title">Calendrier</div>
            <div class="tiny">Jalons & √©ch√©ances (clique sur une t√¢che pour √©diter).</div>
          </div>
          <div class="cal-head">
            <button class="btnlink" id="prev">‚óÄ</button>
            <div class="mono" id="calLabel" style="font-weight:900"></div>
            <button class="btnlink" id="next">‚ñ∂</button>
          </div>
        </div>
        <div class="bd">
          <div class="cal-grid" id="dow"></div>
          <div class="cal-grid" id="cal"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><div><div class="section-title">Pitchs & templates</div><div class="tiny">Copier-coller, ton court, 1 CTA.</div></div></div>
        <div class="bd" style="display:grid;gap:12px">
          <div class="template">
            <span class="pill ok">Pitch ‚Äî Terrain (6 phrases)</span>
            <pre id="tplTerrain"></pre>
            <button class="btnlink" data-copy="#tplTerrain">Copier</button>
          </div>
          <div class="template">
            <span class="pill ok">Pitch ‚Äî Sponsor (6 phrases)</span>
            <pre id="tplSponsor"></pre>
            <button class="btnlink" data-copy="#tplSponsor">Copier</button>
          </div>
          <div class="template">
            <span class="pill warn">Email ‚Äî Confirmation terrain</span>
            <pre id="tplEmail"></pre>
            <button class="btnlink" data-copy="#tplEmail">Copier</button>
          </div>
          <div class="template">
            <span class="pill warn">CTA sponsor (30 min)</span>
            <pre id="tplCTA"></pre>
            <button class="btnlink" data-copy="#tplCTA">Copier</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>üîÅ Supabase DB + Auth + Realtime ¬∑ 1 plan entreprise (auto)</div>
    <div class="mono">arkeoplan-supabase-v3</div>
  </div>

</main>

<div class="toast" id="toast"></div>

<!-- Modal -->
<div id="modal" class="hide" style="position:fixed; inset:0; z-index:999; background:rgba(0,0,0,.55); backdrop-filter: blur(8px);">
  <div style="max-width:780px; margin:6vh auto; padding:0 16px;">
    <div class="card" style="border-radius:22px;">
      <div class="hd">
        <div>
          <div class="section-title" id="mTitleLbl">Nouvelle t√¢che</div>
          <div class="tiny">Sauvegard√© en DB (Supabase).</div>
        </div>
        <button class="btnlink" id="mClose">‚úï</button>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field" style="flex:2">
            <label>Titre</label>
            <input id="mTitle" placeholder="Ex: Obtenir email terrain (site + r√©f√©rent + dates + beta accept√©)"/>
          </div>
          <div class="field">
            <label>Type</label>
            <select id="mType">
              <option value="terrain">Terrain</option><option value="pack">Docs/Pack</option><option value="sponsor">Sponsor</option>
              <option value="contract">Contrat</option><option value="build">Hardening</option><option value="pilot">Pilote</option>
              <option value="report">Rapport</option><option value="loi">LOI phase 2</option>
            </select>
          </div>
          <div class="field">
            <label>Owner</label>
            <input id="mOwner" placeholder="Erwan / Thomas / ..."/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>√âch√©ance</label>
            <input type="date" id="mDue"/>
          </div>
          <div class="field">
            <label>Statut</label>
            <select id="mStatus">
              <option value="todo">√Ä faire</option><option value="doing">En cours</option><option value="blocked">Bloqu√©</option><option value="done">Fait</option>
            </select>
          </div>
          <div class="field">
            <label>Priorit√©</label>
            <select id="mPr">
              <option value="p1">P1 (critique)</option><option value="p2">P2</option><option value="p3">P3</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Notes</label>
          <textarea id="mNotes" placeholder="Contexte, liens, d√©cisions, next step..."></textarea>
        </div>

        <div class="row" style="margin-top:12px; justify-content:space-between">
          <div class="tiny">Astuce : colle ici l‚Äôemail terrain ou les exigences sponsor.</div>
          <div style="display:flex; gap:10px">
            <button class="btnlink" id="mDelete" style="display:none">Supprimer</button>
            <button class="good" id="mSave">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://bejbipoebjzlsugyclqw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_TiMTmX-uqin2PVlsJsjGuw_b11OFSy8";

/* 1 plan entreprise identifi√© par NOM (plus robuste qu‚Äôun UUID hardcod√©) */
const TEAM_PLAN_NAME = "ARKEO Team";

/* ============== CLIENT =================== */
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============== HELPERS ================== */
const $ = id => document.getElementById(id);
function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(window.__t);
  window.__t=setTimeout(()=>t.style.display="none",2400);
}
function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
function shorten(s,n){ return s.length>n ? s.slice(0,n-1)+"‚Ä¶" : s; }

/* ============== CONSTANTS UI ============= */
const TYPE={
  terrain:{l:"Terrain",c:"#7aa2ff"},
  pack:{l:"Docs/Pack",c:"#7ef0c2"},
  sponsor:{l:"Sponsor",c:"#ffcd6b"},
  contract:{l:"Contrat",c:"#7aa2ff"},
  build:{l:"Hardening",c:"#7ef0c2"},
  pilot:{l:"Pilote",c:"#ffcd6b"},
  report:{l:"Rapport",c:"#7aa2ff"},
  loi:{l:"LOI",c:"#7ef0c2"},
};

let teamPlanId = null;
let tasks = [];
let calMonth = (()=>{const d=new Date();d.setDate(1);d.setHours(0,0,0,0);return d;})();
let realtimeChannel = null;

/* ============== AUTH UI ================== */
async function sendMagicLink(){
  const email=$("loginEmail").value.trim();
  if(!email){toast("Email requis.");return;}

  // On ne bloque pas c√¥t√© client, car les emails whitelist (gmail) doivent pouvoir se connecter.
  // On met juste un avertissement si ce n'est pas @arkeobots.com.
  if(!email.toLowerCase().endsWith("@arkeobots.com")){
    const ok = confirm("Email hors @arkeobots.com.\nIl doit √™tre en whitelist c√¥t√© DB pour acc√©der.\n\nContinuer ?");
    if(!ok) return;
  }

  const { error } = await supabaseClient.auth.signInWithOtp({
    email,
    options:{ emailRedirectTo: window.location.href }
  });
  if(error) toast("Erreur: " + error.message);
  else toast("Lien envoy√©. V√©rifie ta bo√Æte mail.");
}

async function logout(){
  await supabaseClient.auth.signOut();
  teardownRealtime();
  setLoggedOutUI();
}

function setLoggedOutUI(){
  $("authPill").textContent="Non connect√©";
  $("authPill").className="pill";
  $("btnOpenLogin").classList.remove("hide");
  $("btnLogout").classList.add("hide");
  $("btnAdd").classList.add("hide");
  $("loginCard").classList.remove("hide");
  $("appCard").classList.add("hide");
  $("grid").classList.add("hide");
}

function setLoggedInUI(email){
  $("authPill").textContent=email||"Connect√©";
  $("authPill").className="pill ok";
  $("btnOpenLogin").classList.add("hide");
  $("btnLogout").classList.remove("hide");
  $("btnAdd").classList.remove("hide");
  $("loginCard").classList.add("hide");
  $("appCard").classList.remove("hide");
  $("grid").classList.remove("hide");
}

/* ============== ACCESS CHECK ============= */
async function assertAllowedUser(){
  // Calls SQL function: public.is_allowed_user()
  const { data, error } = await supabaseClient.rpc("is_allowed_user");
  if(error) throw error;
  if(data !== true){
    // on force un logout pour √©viter une UI "vide"
    await supabaseClient.auth.signOut();
    setLoggedOutUI();
    throw new Error("Acc√®s refus√©: email non autoris√© (@arkeobots.com + whitelist uniquement).");
  }
}

/* ============== PLAN (get or create by name) ============= */
async function getOrCreateTeamPlan(user){
  // try find by name
  const { data: found, error: fErr } = await supabaseClient
    .from("plans")
    .select("*")
    .eq("name", TEAM_PLAN_NAME)
    .limit(1);

  if(fErr) throw fErr;
  if(found && found[0]) return found[0];

  // create
  const { data: created, error: cErr } = await supabaseClient
    .from("plans")
    .insert({ name: TEAM_PLAN_NAME, created_by: user.id })
    .select()
    .single();
  if(cErr) throw cErr;

  return created;
}

async function ensureMember(planId, user){
  const { data: mem, error: mErr } = await supabaseClient
    .from("plan_members")
    .select("*")
    .eq("plan_id", planId)
    .eq("user_id", user.id)
    .limit(1);

  if(mErr) throw mErr;
  if(!mem || mem.length === 0){
    const { error: insErr } = await supabaseClient
      .from("plan_members")
      .insert({ plan_id: planId, user_id: user.id, role: "member" });
    if(insErr) throw insErr;
  }
}

/* ============== SEED TASKS ============= */
function nextMondayISO(){
  const d=new Date();
  const day=d.getDay();
  const diff=(8-day)%7||7;
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}
function addDays(iso,days){
  const d=new Date(iso+"T00:00:00");
  d.setDate(d.getDate()+days);
  return d.toISOString().slice(0,10);
}
function seedTasksForPlan(planId){
  const start = $("startDate").value || nextMondayISO();
  const defaults = [
    {title:"Obtenir email terrain (site + r√©f√©rent + dates + 'beta accept√©') via Siel Bleu", type:"terrain", owner:"Erwan / Siel Bleu", due:addDays(start,3), status:"todo", priority:"p1", notes:"Sortie: email 'OK' du site. Sans √ßa, pas de sponsoring efficace."},
    {title:"Plan B terrain discret (1 site alternatif en Catalogne)", type:"terrain", owner:"Erwan", due:addDays(start,7), status:"todo", priority:"p2", notes:"Ne pas d√©pendre d‚Äôun seul contact."},
    {title:"Finaliser pack sponsor-ready (Programme 50k + Budget 8 lignes + Fiche pilote)", type:"pack", owner:"Erwan", due:addDays(start,6), status:"todo", priority:"p1", notes:"Ajouter: Go/No-Go, baseline privacy/safety, plan reprise <72h."},
    {title:"Lister pi√®ces critiques + co√ªts/d√©lais + spare kit minimum (continuit√©)", type:"pack", owner:"Thomas (CTO)", due:addDays(start,6), status:"todo", priority:"p1", notes:"But: √©viter qu‚Äôune casse stoppe le pilote."},
    {title:"S√©lectionner 2‚Äì3 fondations max + trouver contact direct", type:"sponsor", owner:"Erwan", due:addDays(start,8), status:"todo", priority:"p1", notes:"Process r√©aliste, th√©matique vieillissement/autonomie/inclusion."},
    {title:"Outreach sponsor (CTA 30 min) avec site confirm√© + pack", type:"sponsor", owner:"Erwan", due:addDays(start,10), status:"todo", priority:"p1", notes:"Ton court, factuel, beta assum√©. Relances J+10/J+20 max."},
    {title:"Signer contrat programme sponsoris√© (min 40‚Äì50% upfront)", type:"contract", owner:"Erwan", due:addDays(start,25), status:"todo", priority:"p1", notes:"Inclure: statut beta, limites, confidentialit√©, paiement."},
    {title:"Hardening MVP pilotable ‚Äî jalon S4 (d√©mo pilotable contr√¥l√©e)", type:"build", owner:"Thomas (CTO)", due:addDays(start,28), status:"todo", priority:"p1", notes:"Stabilit√© + instrumentation."},
    {title:"Hardening MVP pilotable ‚Äî jalon S7 (ready-for-site + plan reprise)", type:"build", owner:"Thomas (CTO)", due:addDays(start,49), status:"todo", priority:"p1", notes:"Baseline privacy/safety + continuit√© (spares, reprise)."},
    {title:"Pilote in-site Catalogne (2‚Äì3 semaines) ‚Äî ex√©cution + journal incidents", type:"pilot", owner:"Thomas (CTO)", due:addDays(start,70), status:"todo", priority:"p1", notes:"KPIs sponsor: acceptabilit√©, valeur per√ßue, incidents/temps de reprise."},
    {title:"Rapport final (‚â§3 pages) + restitution site & sponsor", type:"report", owner:"Erwan", due:addDays(start,78), status:"todo", priority:"p1", notes:"R√©sum√© ex√©cutif + r√©sultats + limites + conditions phase 2."},
    {title:"Demander LOI phase 2 (extension / second pilote / pr√©commande) si OK", type:"loi", owner:"Erwan", due:addDays(start,82), status:"todo", priority:"p2", notes:"Apr√®s usage clair + d√©cideur identifi√©."}
  ];
  return defaults.map(d => ({...d, plan_id: planId}));
}

async function ensureSeedIfEmpty(planId){
  const { data: existing, error } = await supabaseClient
    .from("tasks")
    .select("id")
    .eq("plan_id", planId)
    .limit(1);

  if(error) throw error;
  if(existing && existing.length > 0) return;

  const seed = seedTasksForPlan(planId);
  const { error: insErr } = await supabaseClient.from("tasks").insert(seed);
  if(insErr) throw insErr;
  toast("Plan initial cr√©√© (t√¢ches seed).");
}

/* ============== TASKS CRUD ============= */
async function loadTasks(){
  const { data, error } = await supabaseClient
    .from("tasks")
    .select("*")
    .eq("plan_id", teamPlanId)
    .order("due", { ascending: true, nullsFirst: false })
    .order("created_at", { ascending: true });

  if(error) throw error;
  tasks = data || [];
}

async function createTask(t){
  const payload = {
    plan_id: teamPlanId,
    title: t.title,
    type: t.type,
    owner: t.owner || null,
    due: t.due || null,
    status: t.status,
    priority: t.priority,
    notes: t.notes || null,
    updated_at: new Date().toISOString()
  };
  const { error } = await supabaseClient.from("tasks").insert(payload);
  if(error) throw error;
}

async function updateTask(id, patch){
  patch.updated_at = new Date().toISOString();
  const { error } = await supabaseClient.from("tasks").update(patch).eq("id", id);
  if(error) throw error;
}

async function deleteTask(id){
  const { error } = await supabaseClient.from("tasks").delete().eq("id", id);
  if(error) throw error;
}

/* ============== REALTIME ============= */
function teardownRealtime(){
  if(realtimeChannel){
    supabaseClient.removeChannel(realtimeChannel);
    realtimeChannel = null;
  }
}
function setupRealtime(){
  teardownRealtime();
  realtimeChannel = supabaseClient
    .channel("tasks_changes_" + teamPlanId)
    .on("postgres_changes",
      { event:"*", schema:"public", table:"tasks", filter:`plan_id=eq.${teamPlanId}` },
      async ()=> {
        await loadTasks();
        render();
      }
    )
    .subscribe();
}

/* ============== RENDER ============= */
function badge(st){
  if(st==="done") return '<span class="pill ok">Fait</span>';
  if(st==="doing") return '<span class="pill warn">En cours</span>';
  if(st==="blocked") return '<span class="pill bad">Bloqu√©</span>';
  return '<span class="pill">√Ä faire</span>';
}
function updatePill(){
  const blocked = tasks.filter(t=>t.status==="blocked").length;
  const todo = tasks.filter(t=>t.status!=="done").length;
  const p = $("pill");
  if(blocked){ p.className="pill bad"; p.textContent = blocked + " bloqu√©(s)"; return; }
  if(todo===0){ p.className="pill ok"; p.textContent = "Tout est fait"; return; }
  p.className="pill warn"; p.textContent = todo + " √† traiter";
}
function computeStage(){
  const terrain = tasks.find(t=>t.type==="terrain" && (t.title||"").toLowerCase().includes("email terrain"));
  const contract = tasks.find(t=>t.type==="contract");
  const pilot = tasks.find(t=>t.type==="pilot");
  let st = "Terrain ‚Üí Email OK";
  if(terrain && terrain.status==="done") st = "Sponsors ‚Üí Calls / Signature";
  if(contract && contract.status==="done") st = "Hardening ‚Üí 8 semaines";
  if(pilot && pilot.status==="doing") st = "Pilote ‚Üí en cours";
  if(pilot && pilot.status==="done") st = "Rapport ‚Üí puis LOI";
  $("kStage").textContent = st;
}

function renderTable(){
  const fs = $("fStatus").value;
  const ft = $("fType").value;

  let rows = [...tasks];
  if(fs !== "all") rows = rows.filter(t=>t.status===fs);
  if(ft !== "all") rows = rows.filter(t=>t.type===ft);

  const prRank = {p1:0,p2:1,p3:2};
  rows.sort((a,b)=>{
    const da = a.due || "9999-12-31";
    const db = b.due || "9999-12-31";
    if(da<db) return -1;
    if(da>db) return 1;
    return (prRank[a.priority]??9)-(prRank[b.priority]??9);
  });

  $("tbody").innerHTML = rows.map(t=>{
    const meta = TYPE[t.type] || {l:t.type, c:"#7aa2ff"};
    const dot = `<span class="dot" style="background:${meta.c}"></span>`;
    return `<tr>
      <td>
        <div style="font-weight:900">${dot}${esc(t.title)}</div>
        <div class="tiny">Priorit√©: <span class="mono">${(t.priority||"p2").toUpperCase()}</span></div>
      </td>
      <td><span class="pill">${meta.l}</span></td>
      <td>${esc(t.owner||"‚Äî")}</td>
      <td class="mono">${t.due||"‚Äî"}</td>
      <td>${badge(t.status)}</td>
      <td><div class="tiny">${esc((t.notes||"").slice(0,180))}${(t.notes||"").length>180?"‚Ä¶":""}</div></td>
      <td style="text-align:right">
        <button class="btnlink" onclick="openEdit('${t.id}')">√âditer</button>
        <button class="btnlink" onclick="toggleDone('${t.id}')">${t.status==="done"?"‚Ü©Ô∏é":"‚úì"}</button>
      </td>
    </tr>`;
  }).join("");
}

function renderCalendar(){
  const m = new Date(calMonth); m.setDate(1);
  $("calLabel").textContent = m.toLocaleDateString("fr-FR",{month:"long",year:"numeric"});

  const dow = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
  $("dow").innerHTML = dow.map(x=>`<div class="dow">${x}</div>`).join("");

  const y=m.getFullYear(), mo=m.getMonth();
  const first=new Date(y,mo,1);
  const offset=(first.getDay()+6)%7;
  const dim=new Date(y,mo+1,0).getDate();
  const prevDim=new Date(y,mo,0).getDate();

  const cells=[];
  for(let i=0;i<offset;i++){
    const day=prevDim-offset+1+i;
    const d=new Date(y,mo-1,day);
    cells.push({iso:d.toISOString().slice(0,10), day, out:true});
  }
  for(let d=1; d<=dim; d++){
    const dt=new Date(y,mo,d);
    cells.push({iso:dt.toISOString().slice(0,10), day:d, out:false});
  }
  while(cells.length%7!==0){
    const idx=cells.length-(offset+dim)+1;
    const dt=new Date(y,mo+1,idx);
    cells.push({iso:dt.toISOString().slice(0,10), day:idx, out:true});
  }

  const by = {};
  for(const t of tasks){
    if(!t.due) continue;
    (by[t.due] ||= []).push(t);
  }

  $("cal").innerHTML = cells.map(c=>{
    const ev=(by[c.iso]||[]).slice(0,3).map(t=>{
      const meta = TYPE[t.type] || {l:t.type,c:"#7aa2ff"};
      const st=t.status==="done"?"‚úì":t.status==="blocked"?"!":t.status==="doing"?"‚Ä¶":"‚Ä¢";
      return `<div class="event" onclick="openEdit('${t.id}')" title="${esc(t.title)}">
        <span class="dot" style="background:${meta.c}"></span>
        <span class="mono"><b>${st}</b></span>
        ${esc(shorten(t.title, 44))}
      </div>`;
    }).join("");
    return `<div class="day ${c.out?"out":""}">
      <div class="daynum">${c.day}</div>
      ${ev}
    </div>`;
  }).join("");
}

function fillTemplates(){
  const region = $("pilotRegion").value || "Catalogne";
  const onsite = $("onsiteOwner").value || "CTO in-site";
  const cash = $("targetCash").value || "50 000 ‚Ç¨";

  $("tplTerrain").textContent =
`1) Nous d√©veloppons ARKEO, un compagnon de robotique sociale pour seniors, pour soutenir le lien et l‚Äôengagement au quotidien.
2) Prototype fonctionnel ; nous cherchons un site en ${region} pour un pilote in-site court (2‚Äì3 semaines).
3) Pilote encadr√© : un r√©f√©rent c√¥t√© site, cr√©neaux d√©finis, et ${onsite}.
4) Statut assum√© : prototype/beta ‚Äî objectif = acceptabilit√©, usage, points de fiabilit√© √† corriger.
5) Mesures simples : acceptabilit√© (continuer oui/non), valeur per√ßue (1‚Äì5), incidents/temps de reprise ‚Äî rapport remis au site.
6) Prochain pas : confirmation par email (site + r√©f√©rent + dates + ‚Äúbeta accept√©‚Äù).`;

  $("tplSponsor").textContent =
`1) Nous d√©ployons un compagnon de robotique sociale pour seniors.
2) Prototype fonctionnel + terrain activable en ${region}.
3) Programme born√© : 8 semaines hardening ‚ÄúMVP pilotable‚Äù, puis pilote in-site 2‚Äì3 semaines, puis rapport.
4) Inclus : continuit√© (spares/reprise <72h) + baseline privacy/safety (consentement, r√®gles data, proc√©dure incident).
5) Budget demand√© : ${cash} (co-financ√© en nature par l‚Äô√©quipe).
6) Seriez-vous disponible 30 minutes pour valider l‚Äô√©ligibilit√© et la possibilit√© de sponsoring ?`;

  $("tplEmail").textContent =
`Objet : Confirmation pilote ARKEO ‚Äî [Site], [dates]

Bonjour [Nom],

Suite √† notre √©change, voici le r√©capitulatif pour confirmation :
‚Ä¢ Site : [Nom du site], [Ville ‚Äì Catalogne]
‚Ä¢ R√©f√©rent op√©rationnel : [Nom, fonction, t√©l√©phone/email]
‚Ä¢ Fen√™tre : [date d√©but] ‚Üí [date fin] (2‚Äì3 semaines)
‚Ä¢ Statut : prototype/beta accept√© ; op√©rateur ARKEO pr√©sent sur place ; cr√©neaux d√©finis.

Pouvez-vous r√©pondre ‚ÄúOK‚Äù √† ce message pour confirmer ?
Merci,
[Pr√©nom]`;

  $("tplCTA").textContent =
`CTA : ‚ÄúAuriez-vous 30 minutes cette semaine pour valider si vous pouvez sponsoriser le programme 50k (hardening 8 semaines + pilote in-site + rapport) ?‚Äù`;
}

function render(){
  updatePill();
  computeStage();
  renderTable();
  renderCalendar();
  fillTemplates();
}

/* ============== MODAL ============= */
let editId = null;

function openModal(){ $("modal").classList.remove("hide"); }
function closeModal(){ $("modal").classList.add("hide"); }

window.openEdit = function(id){
  const t = tasks.find(x=>x.id===id);
  if(!t) return;
  editId = id;
  $("mTitleLbl").textContent = "√âditer t√¢che";
  $("mTitle").value = t.title || "";
  $("mType").value = t.type || "pack";
  $("mOwner").value = t.owner || "";
  $("mDue").value = t.due || "";
  $("mStatus").value = t.status || "todo";
  $("mPr").value = t.priority || "p2";
  $("mNotes").value = t.notes || "";
  $("mDelete").style.display = "inline-block";
  openModal();
};

function openNew(){
  editId = null;
  $("mTitleLbl").textContent = "Nouvelle t√¢che";
  $("mTitle").value = "";
  $("mType").value = "pack";
  $("mOwner").value = "";
  $("mDue").value = "";
  $("mStatus").value = "todo";
  $("mPr").value = "p2";
  $("mNotes").value = "";
  $("mDelete").style.display = "none";
  openModal();
}

async function saveModal(){
  const t = {
    title: $("mTitle").value.trim(),
    type: $("mType").value,
    owner: $("mOwner").value.trim(),
    due: $("mDue").value,
    status: $("mStatus").value,
    priority: $("mPr").value,
    notes: $("mNotes").value.trim(),
  };
  if(!t.title){ toast("Titre requis."); return; }

  try{
    if(editId){
      await updateTask(editId, t);
      toast("T√¢che mise √† jour.");
    }else{
      await createTask(t);
      toast("T√¢che ajout√©e.");
    }
    closeModal();
    await loadTasks(); render();
  }catch(e){
    console.error(e);
    toast("Erreur: " + (e.message || e));
  }
}

async function delModal(){
  if(!editId) return;
  try{
    await deleteTask(editId);
    toast("T√¢che supprim√©e.");
    closeModal();
    await loadTasks(); render();
  }catch(e){
    console.error(e);
    toast("Erreur: " + (e.message || e));
  }
}

window.toggleDone = async function(id){
  const t = tasks.find(x=>x.id===id);
  if(!t) return;
  const next = (t.status === "done") ? "todo" : "done";
  try{
    await updateTask(id, { status: next });
    await loadTasks(); render();
  }catch(e){
    console.error(e);
    toast("Erreur: " + (e.message || e));
  }
};

/* ============== BOOT ============= */
async function onLoggedIn(user){
  setLoggedInUI(user.email);

  try{
    // 1) DB access check (arkeobots.com + whitelist)
    await assertAllowedUser();

    // 2) get or create company plan
    const plan = await getOrCreateTeamPlan(user);
    teamPlanId = plan.id;

    $("planMeta").textContent = `Plan: ${TEAM_PLAN_NAME} ¬∑ ${teamPlanId.slice(0,8)}‚Ä¶ ¬∑ user: ${user.id.slice(0,8)}‚Ä¶`;

    // 3) ensure membership
    await ensureMember(teamPlanId, user);

    // 4) seed if empty
    await ensureSeedIfEmpty(teamPlanId);

    // 5) load + realtime + render
    await loadTasks();
    setupRealtime();
    render();

  }catch(e){
    console.error(e);
    toast(e.message || String(e));
  }
}

async function boot(){
  $("btnSendLink").addEventListener("click", sendMagicLink);
  $("btnLogout").addEventListener("click", logout);
  $("btnOpenLogin").addEventListener("click", ()=> window.scrollTo({top:0, behavior:"smooth"}));
  $("btnAdd").addEventListener("click", openNew);

  $("mClose").addEventListener("click", closeModal);
  $("mSave").addEventListener("click", saveModal);
  $("mDelete").addEventListener("click", delModal);
  $("modal").addEventListener("click", (e)=>{ if(e.target.id==="modal") closeModal(); });

  $("fStatus").addEventListener("change", render);
  $("fType").addEventListener("change", render);

  $("prev").addEventListener("click", ()=>{ calMonth.setMonth(calMonth.getMonth()-1); calMonth.setDate(1); renderCalendar(); });
  $("next").addEventListener("click", ()=>{ calMonth.setMonth(calMonth.getMonth()+1); calMonth.setDate(1); renderCalendar(); });

  // copy buttons
  document.querySelectorAll("[data-copy]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const sel = btn.getAttribute("data-copy");
      const el = document.querySelector(sel);
      if(!el) return;
      await navigator.clipboard.writeText(el.textContent);
      toast("Copi√©.");
    });
  });

  // persist the 4 header inputs locally (UI-only)
  const LS="arkeoplan_ui_v1";
  const saved = localStorage.getItem(LS);
  if(saved){
    try{
      const obj=JSON.parse(saved);
      $("startDate").value = obj.startDate || nextMondayISO();
      $("targetCash").value = obj.targetCash || "50 000 ‚Ç¨";
      $("pilotRegion").value = obj.pilotRegion || "Catalogne (Barcelone si possible)";
      $("onsiteOwner").value = obj.onsiteOwner || "Thomas (CTO) ‚Äî full in-site";
    }catch(e){}
  }else{
    $("startDate").value = nextMondayISO();
  }
  const saveUI=()=>{
    localStorage.setItem(LS, JSON.stringify({
      startDate:$("startDate").value,
      targetCash:$("targetCash").value,
      pilotRegion:$("pilotRegion").value,
      onsiteOwner:$("onsiteOwner").value
    }));
    fillTemplates();
  };
  ["startDate","targetCash","pilotRegion","onsiteOwner"].forEach(id=>{
    $(id).addEventListener(id==="startDate" ? "change" : "input", saveUI);
  });

  // auth state
  const { data: sess } = await supabaseClient.auth.getSession();
  if(sess?.session) await onLoggedIn(sess.session.user);
  else setLoggedOutUI();

  supabaseClient.auth.onAuthStateChange(async (_event, session)=>{
    if(session?.user) await onLoggedIn(session.user);
    else { teardownRealtime(); setLoggedOutUI(); }
  });
}

boot();
</script>

</body>
</html>
